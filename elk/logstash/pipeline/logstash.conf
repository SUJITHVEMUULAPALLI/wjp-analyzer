# Logstash Pipeline Configuration
# ===============================

input {
  # File input for WJP ANALYSER logs
  file {
    path => "/var/log/wjp-analyser/*.log"
    start_position => "beginning"
    codec => "json"
    tags => ["wjp-analyser", "application"]
  }
  
  # Beats input for Filebeat
  beats {
    port => 5044
  }
  
  # TCP input for structured logs
  tcp {
    port => 5000
    codec => json_lines
    tags => ["wjp-analyser", "structured"]
  }
}

filter {
  # Parse WJP ANALYSER application logs
  if "wjp-analyser" in [tags] {
    # Parse timestamp
    date {
      match => [ "timestamp", "ISO8601" ]
    }
    
    # Parse log level
    if [level] {
      mutate {
        add_field => { "log_level" => "%{level}" }
      }
    }
    
    # Parse component
    if [component] {
      mutate {
        add_field => { "service_component" => "%{component}" }
      }
    }
    
    # Parse user information
    if [user_id] {
      mutate {
        add_field => { "user_id" => "%{user_id}" }
      }
    }
    
    # Parse request information
    if [request_id] {
      mutate {
        add_field => { "request_id" => "%{request_id}" }
      }
    }
    
    # Parse performance metrics
    if [duration] {
      mutate {
        convert => { "duration" => "float" }
        add_field => { "performance_duration" => "%{duration}" }
      }
    }
    
    # Parse error information
    if [error] {
      mutate {
        add_field => { "error_message" => "%{error}" }
        add_field => { "error_type" => "%{error_type}" }
      }
    }
    
    # Parse security events
    if [security_event] {
      mutate {
        add_field => { "security_event_type" => "%{security_event}" }
      }
    }
    
    # Parse business metrics
    if [business_metric] {
      mutate {
        add_field => { "business_metric_name" => "%{business_metric}" }
        convert => { "metric_value" => "float" }
      }
    }
  }
  
  # Parse Docker container logs
  if [container] {
    json {
      source => "message"
    }
  }
  
  # Add host information
  mutate {
    add_field => { "hostname" => "%{[host][name]}" }
    add_field => { "environment" => "production" }
  }
}

output {
  # Output to Elasticsearch
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "wjp-analyser-%{+YYYY.MM.dd}"
    template_name => "wjp-analyser"
    template => "/usr/share/logstash/templates/wjp-analyser.json"
    template_overwrite => true
  }
  
  # Debug output (remove in production)
  stdout {
    codec => rubydebug
  }
}
