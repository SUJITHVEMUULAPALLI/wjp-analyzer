<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WJP Image Analysis Results</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .score-excellent { color: #28a745; font-weight: bold; }
        .score-moderate { color: #ffc107; font-weight: bold; }
        .score-poor { color: #dc3545; font-weight: bold; }
        .metric-card { margin-bottom: 1rem; }
        .flag-active { background-color: #f8d7da; border-left: 4px solid #dc3545; }
        .suggestion-item { margin-bottom: 0.5rem; }
        .analysis-section { margin-bottom: 2rem; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            <div class="container">
                <a class="navbar-brand" href="{{ url_for('index') }}">WJP Analyzer</a>
                <div class="navbar-nav ms-auto">
                    <a class="nav-link" href="{{ url_for('index') }}">Home</a>
                </div>
            </div>
        </nav>

        <div class="container mt-4">
            <div class="row">
                <div class="col-12">
                    <h1 class="mb-4">Image Analysis Results</h1>
                    
                    <!-- Analysis ID -->
                    <div class="alert alert-info">
                        <strong>Analysis ID:</strong> {{ analysis_id }}
                    </div>

                    <!-- Overall Score -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h3 class="mb-0">Overall Suitability Score</h3>
                        </div>
                        <div class="card-body text-center">
                            {% set score_class = 'score-excellent' if report.score >= 75 else 'score-moderate' if report.score >= 50 else 'score-poor' %}
                            <h1 class="{{ score_class }}">{{ report.score }}/100</h1>
                            {% if report.score >= 75 %}
                                <p class="text-success">✅ <strong>Excellent</strong> - Ready for DXF conversion</p>
                            {% elif report.score >= 50 %}
                                <p class="text-warning">⚠️ <strong>Moderate</strong> - Review suggestions, may need preprocessing</p>
                            {% else %}
                                <p class="text-danger">❌ <strong>Poor</strong> - Significant issues, requires substantial work</p>
                            {% endif %}
                            
                            {% if report.gate_decision %}
                                <p><strong>Decision:</strong> {{ report.gate_decision.reason }}</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Basic Information -->
                    <div class="analysis-section">
                        <h3>Basic Information</h3>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card metric-card">
                                    <div class="card-body">
                                        <h6 class="card-title">Image Size</h6>
                                        <p class="card-text">{{ report.image_original_size.w }} × {{ report.image_original_size.h }} pixels</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card metric-card">
                                    <div class="card-body">
                                        <h6 class="card-title">Aspect Ratio</h6>
                                        <p class="card-text">{{ "%.2f"|format(report.basic_stats.aspect_ratio) }}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card metric-card">
                                    <div class="card-body">
                                        <h6 class="card-title">Mean Gray Value</h6>
                                        <p class="card-text">{{ "%.1f"|format(report.basic_stats.mean_gray) }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Orientation -->
                    {% if report.orientation.skew_angle_deg != 0 %}
                    <div class="analysis-section">
                        <h3>Orientation</h3>
                        <div class="alert alert-warning">
                            <strong>Skew Detected:</strong> {{ "%.1f"|format(report.orientation.skew_angle_deg) }} degrees
                        </div>
                    </div>
                    {% endif %}

                    <!-- Texture Metrics -->
                    <div class="analysis-section">
                        <h3>Texture & Edge Analysis</h3>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="card metric-card">
                                    <div class="card-body">
                                        <h6 class="card-title">Edge Density</h6>
                                        <p class="card-text">{{ "%.3f"|format(report.texture_metrics.edge_density) }}</p>
                                        <small class="text-muted">Ideal: 0.05-0.25</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card metric-card">
                                    <div class="card-body">
                                        <h6 class="card-title">Edge Contrast</h6>
                                        <p class="card-text">{{ "%.1f"|format(report.texture_metrics.edge_contrast_ratio) }}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card metric-card">
                                    <div class="card-body">
                                        <h6 class="card-title">Entropy</h6>
                                        <p class="card-text">{{ "%.2f"|format(report.texture_metrics.entropy) }}</p>
                                        <small class="text-muted">Ideal: 3.0-6.0</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card metric-card">
                                    <div class="card-body">
                                        <h6 class="card-title">FFT Energy</h6>
                                        <p class="card-text">{{ "%.3f"|format(report.texture_metrics.fft_highfreq_energy) }}</p>
                                        <small class="text-muted">Max: 0.15</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Topology -->
                    <div class="analysis-section">
                        <h3>Topology Analysis</h3>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="card metric-card">
                                    <div class="card-body">
                                        <h6 class="card-title">Total Contours</h6>
                                        <p class="card-text">{{ report.topology_preview.total_contours }}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card metric-card">
                                    <div class="card-body">
                                        <h6 class="card-title">Closed Contours</h6>
                                        <p class="card-text">{{ report.topology_preview.closed_contours }}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card metric-card">
                                    <div class="card-body">
                                        <h6 class="card-title">Closed Ratio</h6>
                                        <p class="card-text">{{ "%.1f"|format(report.topology_preview.closed_ratio * 100) }}%</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card metric-card">
                                    <div class="card-body">
                                        <h6 class="card-title">Small Features</h6>
                                        <p class="card-text">{{ report.topology_preview.small_features_count }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Manufacturability -->
                    <div class="analysis-section">
                        <h3>Manufacturability</h3>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card metric-card">
                                    <div class="card-body">
                                        <h6 class="card-title">Minimum Spacing</h6>
                                        <p class="card-text">{{ "%.2f"|format(report.manufacturability.min_spacing_unit) }} units</p>
                                        <small class="text-muted">Minimum: 3.0 units</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card metric-card">
                                    <div class="card-body">
                                        <h6 class="card-title">Minimum Radius</h6>
                                        <p class="card-text">{{ "%.2f"|format(report.manufacturability.min_radius_unit) }} units</p>
                                        <small class="text-muted">Minimum: 1.5 units</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Active Flags -->
                    {% set active_flags = [] %}
                    {% for flag, value in report.flags.items() %}
                        {% if value and flag != 'skew_detected_deg' %}
                            {% set _ = active_flags.append(flag) %}
                        {% endif %}
                    {% endfor %}
                    
                    {% if active_flags %}
                    <div class="analysis-section">
                        <h3>Issues Detected</h3>
                        <div class="alert alert-danger">
                            <h6>Active Flags:</h6>
                            <ul class="mb-0">
                                {% for flag in active_flags %}
                                <li>{{ flag.replace('_', ' ').title() }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Suggestions -->
                    {% if report.suggestions %}
                    <div class="analysis-section">
                        <h3>Recommendations</h3>
                        <div class="card">
                            <div class="card-body">
                                <ol class="mb-0">
                                    {% for suggestion in report.suggestions %}
                                    <li class="suggestion-item">{{ suggestion }}</li>
                                    {% endfor %}
                                </ol>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Actions -->
                    <div class="analysis-section">
                        <h3>Actions</h3>
                        <div class="d-grid gap-2 d-md-flex">
                            <a href="{{ url_for('index') }}" class="btn btn-primary">Analyze Another Image</a>
                            {% if report.score >= 75 %}
                            <button class="btn btn-success" onclick="alert('DXF conversion feature coming soon!')">Proceed to DXF Conversion</button>
                            {% else %}
                            <button class="btn btn-warning" onclick="alert('Please address the suggestions above before proceeding to DXF conversion.')">Preprocess Image</button>
                            {% endif %}
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

