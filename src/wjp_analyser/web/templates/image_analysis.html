{% extends "base.html" %}
{% block content %}
<section class="card">
    <h2>Image Analysis</h2>
    <p>Upload an image to analyze its suitability for DXF conversion and waterjet cutting.</p>
    
    <form id="imageAnalysisForm" enctype="multipart/form-data">
        <div class="form-group">
            <label for="file">Select Image File:</label>
            <input type="file" id="file" name="file" accept=".jpg,.jpeg,.png,.bmp,.tiff,.tif" required>
            <small class="form-text text-muted">Supported formats: JPG, PNG, BMP, TIFF</small>
        </div>
        
        <div class="form-row">
            <div class="form-group col-md-6">
                <label for="min_score">Minimum Score Threshold:</label>
                <select id="min_score" name="min_score" class="form-control">
                    <option value="50">50 - Lenient</option>
                    <option value="75" selected>75 - Standard</option>
                    <option value="90">90 - Strict</option>
                </select>
                <small class="form-text text-muted">Minimum score required to proceed (0-100)</small>
            </div>
            
            <div class="form-group col-md-6">
                <label for="px_to_unit">Pixel to Unit Ratio:</label>
                <input type="number" id="px_to_unit" name="px_to_unit" value="1.0" step="0.1" min="0.01" class="form-control">
                <small class="form-text text-muted">Units per pixel (e.g., 0.1 for 0.1mm/pixel)</small>
            </div>
        </div>
        
        <div class="form-group">
            <button type="submit" class="btn btn-primary" id="analyzeBtn">
                <span id="analyzeText">Analyze Image</span>
                <span id="analyzeSpinner" class="spinner-border spinner-border-sm ms-2" style="display: none;"></span>
            </button>
        </div>
    </form>
    
    <div id="analysisResults" style="display: none;">
        <h3>Analysis Results</h3>
        <div id="resultsContent"></div>
    </div>
</section>

<script>
document.getElementById('imageAnalysisForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const analyzeBtn = document.getElementById('analyzeBtn');
    const analyzeText = document.getElementById('analyzeText');
    const analyzeSpinner = document.getElementById('analyzeSpinner');
    const resultsDiv = document.getElementById('analysisResults');
    const resultsContent = document.getElementById('resultsContent');
    
    // Show loading state
    analyzeBtn.disabled = true;
    analyzeText.textContent = 'Analyzing...';
    analyzeSpinner.style.display = 'inline-block';
    resultsDiv.style.display = 'none';
    
    try {
        const response = await fetch('/analyze-image', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Display results
            displayResults(data);
            resultsDiv.style.display = 'block';
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Error analyzing image: ' + error.message);
    } finally {
        // Reset button state
        analyzeBtn.disabled = false;
        analyzeText.textContent = 'Analyze Image';
        analyzeSpinner.style.display = 'none';
    }
});

function displayResults(data) {
    const resultsContent = document.getElementById('resultsContent');
    
    const scoreClass = data.score >= 75 ? 'text-success' : data.score >= 50 ? 'text-warning' : 'text-danger';
    const statusIcon = data.score >= 75 ? '✅' : data.score >= 50 ? '⚠️' : '❌';
    const statusText = data.score >= 75 ? 'Ready for DXF conversion' : 
                      data.score >= 50 ? 'Needs preprocessing' : 'Significant issues';
    
    resultsContent.innerHTML = `
        <div class="alert ${data.should_proceed ? 'alert-success' : 'alert-warning'}">
            <h4>${statusIcon} Score: <span class="${scoreClass}">${data.score}/100</span></h4>
            <p><strong>Status:</strong> ${statusText}</p>
            <p><strong>Decision:</strong> ${data.gate_decision.reason || 'Analysis complete'}</p>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <h5>Basic Information</h5>
                <ul>
                    <li><strong>Size:</strong> ${data.basic_stats.aspect_ratio.toFixed(2)} aspect ratio</li>
                    <li><strong>Mean Gray:</strong> ${data.basic_stats.mean_gray.toFixed(1)}</li>
                    <li><strong>Std Dev:</strong> ${data.basic_stats.std_gray.toFixed(1)}</li>
                </ul>
                
                <h5>Orientation</h5>
                <ul>
                    <li><strong>Skew:</strong> ${data.orientation.skew_angle_deg.toFixed(1)}°</li>
                </ul>
            </div>
            
            <div class="col-md-6">
                <h5>Topology</h5>
                <ul>
                    <li><strong>Total Contours:</strong> ${data.topology_preview.total_contours}</li>
                    <li><strong>Closed Contours:</strong> ${data.topology_preview.closed_contours}</li>
                    <li><strong>Closed Ratio:</strong> ${(data.topology_preview.closed_ratio * 100).toFixed(1)}%</li>
                    <li><strong>Small Features:</strong> ${data.topology_preview.small_features_count}</li>
                </ul>
                
                <h5>Manufacturability</h5>
                <ul>
                    <li><strong>Min Spacing:</strong> ${data.manufacturability.min_spacing_unit.toFixed(2)} units</li>
                    <li><strong>Min Radius:</strong> ${data.manufacturability.min_radius_unit.toFixed(2)} units</li>
                </ul>
            </div>
        </div>
        
        ${data.suggestions && data.suggestions.length > 0 ? `
        <h5>Recommendations</h5>
        <ol>
            ${data.suggestions.map(suggestion => `<li>${suggestion}</li>`).join('')}
        </ol>
        ` : ''}
        
        <div class="mt-3">
            <a href="/image-analysis/${data.analysis_id}" class="btn btn-info">View Detailed Report</a>
            ${data.should_proceed ? 
                '<button class="btn btn-success ms-2" onclick="alert(\'DXF conversion feature coming soon!\')">Proceed to DXF Conversion</button>' :
                '<button class="btn btn-warning ms-2" onclick="alert(\'Please address the suggestions above first.\')">Preprocess Image</button>'
            }
        </div>
    `;
}
</script>
{% endblock %}

