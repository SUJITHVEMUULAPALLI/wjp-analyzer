{% extends "base.html" %}
{% block content %}
<section class="card">
    <h2>Enhanced DXF Analysis with Layer Management &amp; Nesting</h2>
    <p class="section-description">Move from raw DXF to manufacturing-ready G-code in a single guided workspace.</p>

    <ol class="analysis-stepper" id="analysisStepper">
        <li class="analysis-step" id="step-upload" data-step="Step 1" data-status="active">
            <h4>Upload</h4>
            <p>Select a DXF file and kerf settings.</p>
        </li>
        <li class="analysis-step" id="step-analyze" data-step="Step 2" data-status="idle">
            <h4>Analysis</h4>
            <p>Review detected objects and metrics.</p>
        </li>
        <li class="analysis-step" id="step-layers" data-step="Step 3" data-status="idle">
            <h4>Layers</h4>
            <p>Organise parts into cutting layers.</p>
        </li>
        <li class="analysis-step" id="step-nesting" data-step="Step 4" data-status="idle">
            <h4>Nesting</h4>
            <p>Optimise sheet utilisation.</p>
        </li>
        <li class="analysis-step" id="step-gcode" data-step="Step 5" data-status="idle">
            <h4>G-Code</h4>
            <p>Generate machine-ready toolpaths.</p>
        </li>
        <li class="analysis-step" id="step-cost" data-step="Step 6" data-status="idle">
            <h4>Costs</h4>
            <p>Estimate cutting time and pricing.</p>
        </li>
    </ol>

    <div class="section-panel" id="uploadSection">
        <h3>Upload DXF</h3>
        <p class="section-description">Upload a clean DXF and optionally adjust kerf compensation before analysis.</p>
        <form id="uploadForm" class="form-grid" enctype="multipart/form-data">
            <div class="form-field">
                <label for="file">DXF File</label>
                <input type="file" id="file" name="file" accept=".dxf" required>
                <small>Supported: AutoCAD DXF R12+</small>
            </div>
            <div class="form-field">
                <label for="kerf">Kerf Compensation (mm)</label>
                <input type="number" id="kerf" name="kerf" step="0.05" value="{{ form_defaults.kerf }}" min="0.1" max="5.0">
                <small>Used to highlight geometry that could be lost during cutting.</small>
            </div>
        </form>
        <div class="section-actions">
            <button type="button" class="btn btn-primary" onclick="uploadAndAnalyze()">Upload &amp; Analyze</button>
            <button type="button" class="btn btn-secondary" onclick="resetWorkspace()">Reset Workspace</button>
        </div>
    </div>

    <div class="section-panel" id="analysisSection" data-hidden="true">
        <h3>Object Analysis</h3>
        <p class="section-description">Review detected contour statistics to understand cut complexity before assigning layers.</p>
        <div id="analysisStats" class="results-board">
            <div class="empty-state">Upload a DXF file to see detected object metrics.</div>
        </div>
    </div>

    <div class="section-panel" id="selectionSection" data-hidden="true">
        <h3>Object Selection</h3>
        <p class="section-description">Select geometry to include in specific layers or workflows.</p>
        <div class="section-actions">
            <button class="btn btn-primary" onclick="selectAllObjects()">Select All</button>
            <button class="btn btn-secondary" onclick="deselectAllObjects()">Deselect</button>
            <button class="btn btn-info" onclick="renderAnalysisStats()">Refresh Stats</button>
        </div>
        <div class="object-list" id="objectList">
            <div class="empty-state">Analysis results will populate detected objects here.</div>
        </div>
    </div>

    <div class="section-panel" id="layerSection" data-hidden="true">
        <h3>Layer Management</h3>
        <p class="section-description">Create production layers for base cuts, nested layouts, or custom groupings.</p>
        <div class="section-actions">
            <button class="btn btn-primary" onclick="showCreateLayerModal()">Create Layer</button>
            <button class="btn btn-info" onclick="createDefaultLayers()">Create Default Layers</button>
            <button class="btn btn-success" onclick="assignSelectedToLayers()">Assign Selected</button>
        </div>
        <div class="layer-list" id="layerList">
            <div class="empty-state">No layers yet. Create one to begin organising the job.</div>
        </div>
    </div>

    <div class="section-panel" id="nestingSection" data-hidden="true">
        <h3>Nesting Optimization</h3>
        <p class="section-description">Experiment with layout optimisation to improve sheet utilisation and cost.</p>
        <div class="section-actions">
            <button class="btn btn-primary" onclick="runNestingOptimization()">Run Optimization</button>
            <button class="btn btn-info" onclick="compareAlgorithms()">Compare Algorithms</button>
            <button class="btn btn-success" onclick="generateReport()">Generate Report</button>
        </div>
        <div id="nestingResults" class="results-board">
            <div class="empty-state">Optimisation results will appear here.</div>
        </div>
    </div>

    <div class="section-panel" id="gcodeSection" data-hidden="true">
        <h3>G-Code Generation</h3>
        <p class="section-description">Generate toolpaths and review high-level statistics before exporting.</p>
        <div class="section-actions">
            <button class="btn btn-primary" onclick="generateGCode()">Generate G-Code</button>
            <button class="btn btn-info" onclick="downloadGCode()">Download G-Code</button>
            <button class="btn btn-warning" onclick="previewGCode()">Preview G-Code</button>
        </div>
        <div id="gcodeResults" class="results-board">
            <div class="empty-state">Generate G-code to view toolpath metrics.</div>
        </div>
    </div>

    <div class="section-panel" id="costSection" data-hidden="true">
        <h3>Cost Analysis</h3>
        <p class="section-description">Estimate production cost and timeline to support quoting.</p>
        <div class="section-actions">
            <button class="btn btn-primary" onclick="calculateCosts()">Calculate Costs</button>
            <button class="btn btn-info" onclick="optimizeCosts()">Optimize Costs</button>
            <button class="btn btn-success" onclick="generateCostReport()">Generate Cost Report</button>
        </div>
        <div id="costResults" class="results-board">
            <div class="empty-state">Run cost analysis to see detailed breakdowns.</div>
        </div>
    </div>

    <div class="form-actions">
        <a class="link-button" href="{{ url_for('index') }}">Back to Workflow</a>
    </div>
</section>

<!-- Modals -->
<!-- Create Layer Modal -->
<div class="modal" id="createLayerModal">
    <div class="modal-content">
        <span class="close" onclick="closeCreateLayerModal()">&times;</span>
        <h3>Create New Layer</h3>
        <form id="createLayerForm">
            <div class="form-field">
                <label for="layerName">Layer Name</label>
                <input type="text" id="layerName" required>
            </div>
            <div class="form-field">
                <label for="layerType">Layer Type</label>
                <select id="layerType">
                    <option value="base">Base Layer (Full DXF Path)</option>
                    <option value="nested">Nested Layer (Optimized)</option>
                    <option value="custom">Custom Layer</option>
                </select>
            </div>
            <div class="form-field">
                <label for="layerDescription">Description</label>
                <textarea id="layerDescription" rows="3"></textarea>
            </div>
            <button type="button" onclick="createLayer()">Create Layer</button>
        </form>
    </div>
</div>

<!-- Progress Modal -->
<div class="modal" id="progressModal">
    <div class="modal-content">
        <h3>Processing...</h3>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <p id="progressText">Please wait...</p>
    </div>
</div>

<div id="toastContainer" class="toast-container"></div>

<script>
let objects = [];
let layers = [];
let selectedObjects = new Set();
let currentDxfPath = null;
let lastGcodeId = null;
let lastGcodePath = null;

const stepNodes = {
    upload: document.getElementById('step-upload'),
    analyze: document.getElementById('step-analyze'),
    layers: document.getElementById('step-layers'),
    nesting: document.getElementById('step-nesting'),
    gcode: document.getElementById('step-gcode'),
    cost: document.getElementById('step-cost'),
};

const toastContainer = document.getElementById('toastContainer');
const progressModal = document.getElementById('progressModal');
const progressFill = document.getElementById('progressFill');
const progressMessage = document.getElementById('progressText');

const numberFormatter = new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 });
const currencyFormatter = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' });

function decimalFormatter(digits = 2) {
    return new Intl.NumberFormat('en-US', {
        maximumFractionDigits: digits,
        minimumFractionDigits: digits,
    });
}

function formatNumber(value) {
    if (!isFinite(value)) return '--';
    return numberFormatter.format(value);
}

function formatDecimal(value, digits = 2) {
    if (!isFinite(value)) return '--';
    return decimalFormatter(digits).format(value);
}

function formatCurrency(value) {
    if (!isFinite(value)) return '--';
    return currencyFormatter.format(value);
}

function formatDuration(minutes) {
    if (!isFinite(minutes) || minutes < 0) return '--';
    if (minutes < 1) return `${Math.round(minutes * 60)} s`;
    const hours = Math.floor(minutes / 60);
    const mins = Math.round(minutes % 60);
    if (hours) {
        return `${hours}h ${mins}m`;
    }
    return `${mins} min`;
}

function formatPercent(value) {
    if (!isFinite(value)) return '--';
    return `${decimalFormatter(1).format(value * 100)}%`;
}

function setStepStatus(step, status) {
    const node = stepNodes[step];
    if (!node) return;
    node.setAttribute('data-status', status);
}

function resetStepper() {
    setStepStatus('upload', 'active');
    setStepStatus('analyze', 'idle');
    setStepStatus('layers', 'idle');
    setStepStatus('nesting', 'idle');
    setStepStatus('gcode', 'idle');
    setStepStatus('cost', 'idle');
}

resetStepper();

function showSection(id, options = {}) {
    const panel = document.getElementById(id);
    if (!panel) return;
    panel.removeAttribute('data-hidden');
    if (options.scroll !== false) {
        panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}

function hideSection(id) {
    const panel = document.getElementById(id);
    if (!panel) return;
    panel.setAttribute('data-hidden', 'true');
}

function pushToast(title, detail = '', type = 'info') {
    if (!toastContainer) {
        window.alert(`${title}${detail ? ': ' + detail : ''}`);
        return;
    }
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `<div><strong>${title}</strong>${detail ? `<p>${detail}</p>` : ''}</div>`;
    toastContainer.appendChild(toast);
    setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 200);
    }, 4500);
}

function resetWorkspace() {
    objects = [];
    layers = [];
    selectedObjects = new Set();
    currentDxfPath = null;
    lastGcodeId = null;
    lastGcodePath = null;

    resetStepper();
    hideSection('analysisSection');
    hideSection('selectionSection');
    hideSection('layerSection');
    hideSection('nestingSection');
    hideSection('gcodeSection');
    hideSection('costSection');

    renderAnalysisStats();
    renderObjectList();
    renderLayerList();
    document.getElementById('nestingResults').innerHTML = '<div class="empty-state">Optimisation results will appear here.</div>';
    document.getElementById('gcodeResults').innerHTML = '<div class="empty-state">Generate G-code to view toolpath metrics.</div>';
    document.getElementById('costResults').innerHTML = '<div class="empty-state">Run cost analysis to see detailed breakdowns.</div>';

    pushToast('Workspace reset', 'Upload a new DXF to start again.', 'info');
}

function uploadAndAnalyze() {
    const fileInput = document.getElementById('file');
    const kerfInput = document.getElementById('kerf');
    
    if (!fileInput || !fileInput.files.length) {
        pushToast('Select a DXF file', 'Choose a DXF before uploading.', 'warning');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    formData.append('kerf', kerfInput ? kerfInput.value : 1.1);
    
    showProgressModal('Uploading and analysing DXF…', 25);
    
    fetch('/layers/api/upload-dxf', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
            if (!data.success) {
                throw new Error(data.error || 'Unknown error');
            }

            objects = Array.isArray(data.objects) ? data.objects : [];
            layers = [];
            selectedObjects = new Set();
            currentDxfPath = data.file_path || null;

            renderObjectList();
            renderAnalysisStats();
            renderLayerList();

            showSection('analysisSection');
            showSection('selectionSection');
            hideSection('layerSection');
            hideSection('nestingSection');
            hideSection('gcodeSection');
            hideSection('costSection');

            setStepStatus('upload', 'done');
            setStepStatus('analyze', 'active');

            pushToast('Analysis ready', `${formatNumber(objects.length)} objects detected.`, 'success');
        })
        .catch(err => {
            pushToast('Upload failed', err.message || 'Unable to analyse the DXF.', 'error');
        })
        .finally(() => closeProgressModal());
}

function renderObjectList() {
    const container = document.getElementById('objectList');
    if (!container) return;

    if (!objects.length) {
        container.innerHTML = '<div class="empty-state">Analysis results will populate detected objects here.</div>';
        return;
    }

    container.innerHTML = '';
    objects.forEach(obj => {
        const item = document.createElement('label');
        item.className = 'object-item';
        const checked = selectedObjects.has(obj.object_id);
        item.innerHTML = `
            <div class="object-summary">
                <input type="checkbox" ${checked ? 'checked' : ''} data-object-id="${obj.object_id}">
            <div>
                    <strong>${obj.object_type}</strong> — ${obj.name || 'Unnamed'}
                    <br><small>Area: ${formatDecimal(obj.geometry?.area || 0, 2)} • Complexity: ${obj.complexity}</small>
                </div>
            </div>
            <span class="object-meta">Layer: ${obj.assigned_layer || '—'}</span>
        `;
        item.querySelector('input').addEventListener('change', event => {
            const id = event.target.dataset.objectId;
            if (!id) return;
            if (event.target.checked) {
                selectedObjects.add(id);
            } else {
                selectedObjects.delete(id);
            }
            renderAnalysisStats();
        });
        container.appendChild(item);
    });
}

function renderAnalysisStats() {
    const board = document.getElementById('analysisStats');
    if (!board) return;

    if (!objects.length) {
        board.innerHTML = '<div class="empty-state">Upload a DXF file to see detected object metrics.</div>';
        return;
    }

    const totalArea = objects.reduce((sum, obj) => sum + (obj.geometry?.area || 0), 0);
    const complexityCounts = objects.reduce((acc, obj) => {
        const key = obj.complexity || 'Unknown';
        acc[key] = (acc[key] || 0) + 1;
        return acc;
    }, {});
    const dominantComplexity = Object.entries(complexityCounts).sort((a, b) => b[1] - a[1])[0];

    board.innerHTML = `
        <div class="result-card">
            <span class="label">Detected objects</span>
            <span class="value">${formatNumber(objects.length)}</span>
            <span class="meta">${formatNumber(selectedObjects.size)} selected</span>
        </div>
        <div class="result-card">
            <span class="label">Total area</span>
            <span class="value">${formatDecimal(totalArea, 2)} mm²</span>
            <span class="meta">Average ${formatDecimal(totalArea / objects.length || 0, 2)} mm²</span>
        </div>
        <div class="result-card">
            <span class="label">Kerf</span>
            <span class="value">${document.getElementById('kerf')?.value || '—'} mm</span>
            <span class="meta">Used for clearance checks</span>
        </div>
        <div class="result-card">
            <span class="label">Complexity mix</span>
            <span class="value">${dominantComplexity ? dominantComplexity[0] : '—'}</span>
            <span class="meta">${Object.entries(complexityCounts).map(([label, count]) => `${label}: ${count}`).join(' • ')}</span>
        </div>
    `;
}

function selectAllObjects() {
    objects.forEach(obj => selectedObjects.add(obj.object_id));
    renderObjectList();
    renderAnalysisStats();
    pushToast('Selection updated', 'All objects selected.', 'info');
}

function deselectAllObjects() {
    selectedObjects.clear();
    renderObjectList();
    renderAnalysisStats();
}

function showCreateLayerModal() {
    const modal = document.getElementById('createLayerModal');
    if (!modal) return;
    modal.dataset.open = 'true';
}

function closeCreateLayerModal() {
    const modal = document.getElementById('createLayerModal');
    if (!modal) return;
    delete modal.dataset.open;
}

function createLayer() {
    const nameInput = document.getElementById('layerName');
    const typeInput = document.getElementById('layerType');
    const descriptionInput = document.getElementById('layerDescription');

    if (!nameInput || !nameInput.value.trim()) {
        pushToast('Layer name required', 'Please provide a name for the layer.', 'warning');
        return;
    }
    
    fetch('/layers/api/layers', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            name: nameInput.value.trim(),
            layer_type: typeInput?.value || 'custom',
            description: descriptionInput?.value || ''
        })
    })
    .then(response => response.json())
    .then(data => {
            if (!data.success) {
                throw new Error(data.error || 'Unable to create layer');
            }
            layers.push(data.layer);
            renderLayerList();
            renderAnalysisStats();
            showSection('layerSection', { scroll: false });
            closeCreateLayerModal();
            
            nameInput.value = '';
            if (descriptionInput) descriptionInput.value = '';

            setStepStatus('analyze', 'done');
            setStepStatus('layers', 'active');
            pushToast('Layer created', `${data.layer.name} is ready for assignments.`, 'success');
        })
        .catch(err => pushToast('Layer creation failed', err.message, 'error'));
}

function renderLayerList() {
    const container = document.getElementById('layerList');
    if (!container) return;

    if (!layers.length) {
        container.innerHTML = '<div class="empty-state">No layers yet. Create one to begin organising the job.</div>';
        return;
    }

    container.innerHTML = '';
    layers.forEach(layer => {
        const item = document.createElement('div');
        item.className = 'layer-item';
        item.innerHTML = `
            <div>
                <strong>${layer.name}</strong> — ${layer.layer_type}
                <br><small>${formatNumber(layer.object_count || 0)} objects</small>
            </div>
            <div class="section-actions">
                <button class="btn btn-primary" onclick="optimizeLayer('${layer.layer_id}')">Optimize</button>
                <button class="btn btn-info" onclick="viewLayerDetails('${layer.layer_id}')">View</button>
            </div>
        `;
        container.appendChild(item);
    });
}

function createDefaultLayers() {
    fetch('/layers/api/layers', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            name: 'Base Layer',
            layer_type: 'base',
            description: 'Full DXF path cutting'
        })
    })
    .then(response => response.json())
    .then(data => {
            if (!data.success) return;
            layers.push(data.layer);
            renderLayerList();
            renderAnalysisStats();
            showSection('layerSection', { scroll: false });
            setStepStatus('analyze', 'done');
            setStepStatus('layers', 'active');
            pushToast('Base layer created', 'Default layer ready for assignments.', 'success');
    });
}

function assignSelectedToLayers() {
    if (!selectedObjects.size) {
        pushToast('No objects selected', 'Select objects before assigning to a layer.', 'warning');
        return;
    }
    pushToast('Coming soon', 'Object assignment tooling is on the roadmap.', 'info');
}

function runNestingOptimization() {
    if (!layers.length) {
        pushToast('Create a layer first', 'Build at least one layer before running nesting.', 'warning');
        return;
    }
    
    setStepStatus('layers', 'done');
    setStepStatus('nesting', 'active');
    showSection('nestingSection');

    showProgressModal('Running nesting optimisation…', 45);
    
    setTimeout(() => {
        const utilisation = Math.min(0.95, 0.68 + layers.length * 0.05);
        const sheetCount = Math.max(1, Math.ceil(objects.length / 25));
        const estimatedWaste = 1 - utilisation;

        const board = document.getElementById('nestingResults');
        if (board) {
            board.innerHTML = `
                <div class="result-card">
                    <span class="label">Material utilisation</span>
                    <span class="value">${formatPercent(utilisation)}</span>
                    <span class="meta">${formatNumber(sheetCount)} sheet(s) required</span>
                </div>
                <div class="result-card">
                    <span class="label">Estimated waste</span>
                    <span class="value">${formatPercent(estimatedWaste)}</span>
                    <span class="meta">Based on current layer assignments</span>
                </div>
                <div class="result-card">
                    <span class="label">Optimisation status</span>
                    <span class="value">Completed</span>
                    <span class="meta">Try alternative algorithms to compare layouts</span>
            </div>
        `;
        }

        setStepStatus('nesting', 'done');
        setStepStatus('gcode', 'active');
        showSection('gcodeSection', { scroll: false });
        showSection('costSection', { scroll: false });
        pushToast('Nesting complete', 'Layout optimisation results are ready.', 'success');
        closeProgressModal();
    }, 1800);
}

function compareAlgorithms() {
    pushToast('Coming soon', 'Algorithm comparison is under development.', 'info');
}

function generateReport() {
    pushToast('Coming soon', 'Report generation will arrive in a future update.', 'info');
}

function generateGCode() {
    if (!currentDxfPath) {
        pushToast('Upload required', 'Upload and analyse a DXF before generating G-code.', 'warning');
        return;
    }
    if (!layers.length) {
        pushToast('Create a layer', 'Create at least one layer before G-code generation.', 'warning');
        return;
    }
    
    setStepStatus('gcode', 'active');
    showSection('gcodeSection');

    showProgressModal('Generating toolpaths…', 55);

    fetch('/layers/api/generate-gcode', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ dxf_path: currentDxfPath })
    })
    .then(response => response.json())
    .then(data => {
            if (!data.success) {
                throw new Error(data.error || 'Unable to generate G-code');
            }

            lastGcodeId = data.gcode_id;
            lastGcodePath = data.gcode_path;
            const metrics = data.metrics || {};

            const board = document.getElementById('gcodeResults');
            if (board) {
                board.innerHTML = `
                    <div class="result-card">
                        <span class="label">G-code lines</span>
                        <span class="value">${formatNumber(data.line_count)}</span>
                        <span class="meta">Commands generated</span>
                    </div>
                    <div class="result-card">
                        <span class="label">Cut length</span>
                        <span class="value">${formatDecimal((metrics.length_mm || 0) / 1000, 2)} m</span>
                        <span class="meta">Pierces: ${formatNumber(metrics.pierce_count || 0)}</span>
                    </div>
                    <div class="result-card">
                        <span class="label">Estimated time</span>
                        <span class="value">${formatDuration(data.estimated_time_minutes)}</span>
                        <span class="meta">Feed ${document.getElementById('kerf')?.value || '—'} mm/min</span>
                    </div>
                    <div class="result-card">
                        <span class="label">Saved to</span>
                        <span class="value">${lastGcodePath || 'workspace'}</span>
                        <span class="meta">Use the download button to fetch the file</span>
                </div>
            `;
            }

            setStepStatus('gcode', 'done');
            setStepStatus('cost', 'active');
            pushToast('G-code generated', 'Toolpaths ready for download.', 'success');
        })
        .catch(err => pushToast('G-code failed', err.message, 'error'))
        .finally(() => closeProgressModal());
}

function downloadGCode() {
    if (!lastGcodeId) {
        pushToast('No G-code yet', 'Generate G-code before downloading.', 'warning');
        return;
    }
    window.location.href = `/download-gcode/${encodeURIComponent(lastGcodeId)}`;
}

function previewGCode() {
    if (!lastGcodeId) {
        pushToast('No G-code yet', 'Generate G-code to preview the toolpath.', 'warning');
        return;
    }
    pushToast('Preview coming soon', 'Interactive preview will arrive in a future build.', 'info');
}

function calculateCosts() {
    if (!currentDxfPath) {
        pushToast('Upload required', 'Upload a DXF before calculating costs.', 'warning');
        return;
    }
    
    setStepStatus('cost', 'active');
    showSection('costSection');

    showProgressModal('Calculating costs…', 65);

    fetch('/layers/api/calculate-costs', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ dxf_path: currentDxfPath })
    })
    .then(response => response.json())
    .then(data => {
            if (!data.success) {
                throw new Error(data.error || 'Unable to calculate costs');
            }
            const metrics = data.costs?.metrics || {};
            const board = document.getElementById('costResults');
            if (board) {
                board.innerHTML = `
                    <div class="result-card">
                        <span class="label">Total cost</span>
                        <span class="value">${formatCurrency(data.costs.total_cost)}</span>
                        <span class="meta">Includes machine, pierce & setup</span>
                    </div>
                    <div class="result-card">
                        <span class="label">Machine time</span>
                        <span class="value">${formatDuration(metrics.machine_minutes || 0)}</span>
                        <span class="meta">Pierces: ${formatNumber(metrics.pierce_count || 0)}</span>
                    </div>
                    <div class="result-card">
                        <span class="label">Cutting length</span>
                        <span class="value">${formatDecimal(metrics.length_m || 0, 2)} m</span>
                        <span class="meta">${formatNumber(metrics.length_mm || 0)} mm in total</span>
                    </div>
                    <div class="result-card">
                        <span class="label">Breakdown</span>
                        <span class="value">Material ${formatCurrency(data.costs.material_cost || 0)}</span>
                        <span class="meta">Cutting ${formatCurrency(data.costs.cutting_cost || 0)} • Setup ${formatCurrency(data.costs.setup_cost || 0)}</span>
                </div>
            `;
            }

            setStepStatus('cost', 'done');
            pushToast('Costing ready', 'Estimated production costs calculated.', 'success');
        })
        .catch(err => pushToast('Cost calculation failed', err.message, 'error'))
        .finally(() => closeProgressModal());
}

function optimizeCosts() {
    showProgressModal('Optimising cost parameters…', 55);
    setTimeout(() => {
        const board = document.getElementById('costResults');
        if (board) {
            board.innerHTML += `
                <div class="result-card">
                    <span class="label">Optimisation hint</span>
                    <span class="value">-${formatCurrency(46.75)}</span>
                    <span class="meta">Group similar thickness parts to reduce pierce time.</span>
            </div>
        `;
        }
        closeProgressModal();
        pushToast('Cost optimisation simulated', 'Adjust parameters to refine estimates.', 'info');
    }, 1500);
}

function generateCostReport() {
    pushToast('Coming soon', 'Cost report exports are in development.', 'info');
}

function optimizeLayer(layerId) {
    pushToast('Layer optimisation', `Layer ${layerId} optimisation tooling is coming soon.`, 'info');
}

function viewLayerDetails(layerId) {
    pushToast('Layer details', `Detailed view for ${layerId} is on the roadmap.`, 'info');
}

function showProgressModal(message = 'Processing…', progress = 35) {
    if (progressMessage) progressMessage.textContent = message;
    if (progressModal) progressModal.dataset.open = 'true';
    setProgress(progress);
}

function closeProgressModal() {
    if (progressModal) delete progressModal.dataset.open;
}

function setProgress(value) {
    if (!progressFill) return;
    const clamped = Math.max(5, Math.min(100, value));
    progressFill.style.width = `${clamped}%`;
}

document.getElementById('progressModal')?.addEventListener('click', event => {
    if (event.target.id === 'progressModal') {
        closeProgressModal();
    }
});

renderAnalysisStats();
renderObjectList();
renderLayerList();
</script>
{% endblock %}
