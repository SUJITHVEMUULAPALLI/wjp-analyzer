{% extends "base.html" %}
{% block content %}
<section class="card">
    <h2>Analysis Results</h2>
    <p>Analysis ID: <code>{{ analysis_id }}</code></p>

    <div class="metrics-grid">
        <div class="metric">
            <span class="metric-label">Outer Length</span>
            <span>{{ report.metrics.length_outer_mm | round(1) }} mm</span>
        </div>
        <div class="metric">
            <span class="metric-label">Internal Length</span>
            <span>{{ report.metrics.length_internal_mm | round(1) }} mm</span>
        </div>
        <div class="metric">
            <span class="metric-label">Pierces</span>
            <span>{{ report.metrics.pierces }}</span>
        </div>
    </div>

    {% if report.entities %}
    <div class="metrics-grid">
        <div class="metric">
            <span class="metric-label">Polygons</span>
            <span>{{ report.entities.polygons }}</span>
        </div>
        <div class="metric">
            <span class="metric-label">Internal Loops</span>
            <span>{{ report.entities.inner }}</span>
        </div>
        <div class="metric">
            <span class="metric-label">Outer Loops</span>
            <span>{{ report.entities.outer }}</span>
        </div>
    </div>
    {% endif %}

    <div class="issues">
        <div class="issue-block">
            <h3>Violations ({{ report.violations | length }})</h3>
            {% if report.violations %}
                <ul>
                    {% for issue in report.violations[:5] %}
                        <li><strong>{{ issue.type }}</strong>: {{ issue.message }}</li>
                    {% endfor %}
                </ul>
                {% if report.violations | length > 5 %}
                    <details>
                        <summary>Show all ({{ report.violations | length }})</summary>
                        <ul>
                        {% for issue in report.violations[5:] %}
                            <li><strong>{{ issue.type }}</strong>: {{ issue.message }}</li>
                        {% endfor %}
                        </ul>
                    </details>
                {% endif %}
            {% else %}
                <p>No violations detected.</p>
            {% endif %}
        </div>
        <div class="issue-block">
            <h3>Warnings ({{ report.warnings | length }})</h3>
            {% if report.warnings %}
                <ul>
                    {% for warning in report.warnings[:5] %}
                        <li><strong>{{ warning.type }}</strong>: {{ warning.message }}</li>
                    {% endfor %}
                </ul>
                {% if report.warnings | length > 5 %}
                    <details>
                        <summary>Show all ({{ report.warnings | length }})</summary>
                        <ul>
                        {% for warning in report.warnings[5:] %}
                            <li><strong>{{ warning.type }}</strong>: {{ warning.message }}</li>
                        {% endfor %}
                        </ul>
                    </details>
                {% endif %}
            {% else %}
                <p>No warnings detected.</p>
            {% endif %}
        </div>
    </div>

    {% if lengths %}
        <details>
            <summary><strong>Contours Summary</strong> (click to expand)</summary>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Class</th>
                        <th>Perimeter (mm)</th>
                        <th>Area (mm&sup2;)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in lengths %}
                        <tr>
                            <td>{{ row.id }}</td>
                            <td>{{ row.class }}</td>
                            <td>{{ row.perimeter }}</td>
                            <td>{{ row.area }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </details>
    {% endif %}

    {% if image_metadata %}
        <h3>Image Conversion</h3>
        <p>Contours detected: <strong>{{ image_metadata.contour_count }}</strong></p>
        <ul class="metadata-list">
            <li>Edge threshold: {{ image_metadata.parameters.edge_threshold }}</li>
            <li>Canny thresholds: {{ image_metadata.parameters.canny_low }} / {{ image_metadata.parameters.canny_high }}</li>
            <li>Minimum contour area: {{ image_metadata.parameters.min_contour_area }} px</li>
            <li>Simplify tolerance: {{ image_metadata.parameters.simplify_tolerance }}</li>
            <li>Blur kernel size: {{ image_metadata.parameters.blur_kernel_size }}</li>
        </ul>
    {% endif %}

    {% if debug_images %}
        <h3>Previews</h3>
        <div class="preview-grid">
            {% for item in debug_images %}
                <figure>
                    <img src="{{ item.url }}" alt="{{ item.label }} preview">
                    <figcaption>{{ item.label }}</figcaption>
                </figure>
            {% endfor %}
        </div>
    {% endif %}

    {% if image_metadata %}
        <section class="card" style="margin-top:1rem">
            <h3>Reprocess Image</h3>
            <p>Tweak extraction parameters and rerun without re-uploading.</p>
            <form method="post" action="{{ url_for('reprocess', analysis_id=analysis_id) }}" class="form-grid">
                <div class="form-row">
                    <div class="form-field">
                        <label for="edge_threshold">Canny Sigma (0.01-0.99)</label>
                        <input type="number" name="edge_threshold" id="edge_threshold" step="0.01" min="0.01" max="0.99" value="{{ reprocess_defaults.edge_threshold }}">
                    </div>
                    <div class="form-field">
                        <label for="min_contour_area">Minimum Contour Area (px)</label>
                        <input type="number" name="min_contour_area" id="min_contour_area" min="10" step="10" value="{{ reprocess_defaults.min_contour_area }}">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-field">
                        <label for="simplify_tolerance">Simplify Tolerance</label>
                        <input type="number" name="simplify_tolerance" id="simplify_tolerance" step="0.01" min="0.0001" value="{{ reprocess_defaults.simplify_tolerance }}">
                    </div>
                    <div class="form-field">
                        <label for="blur_kernel_size">Blur Kernel Size</label>
                        <input type="number" name="blur_kernel_size" id="blur_kernel_size" min="3" step="2" value="{{ reprocess_defaults.blur_kernel_size }}">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-field">
                        <label for="scale_mm_per_px">Scale (mm per pixel)</label>
                        <input type="number" name="scale_mm_per_px" id="scale_mm_per_px" step="0.01" min="0.01" value="{{ reprocess_defaults.scale_mm_per_px }}">
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit">Reprocess and Re-analyze</button>
                </div>
            </form>
        </section>
    {% endif %}

    {% if download_links %}
        <h3>Downloads</h3>
        <div class="downloads">
            {% for link in download_links %}
                <a class="download-link" href="{{ link.href }}">{{ link.label }}</a>
            {% endfor %}
            <a class="download-link" href="{{ url_for('export_quote_pdf', analysis_id=analysis_id) }}">Export PDF Quote</a>
            <a class="download-link" href="{{ url_for('export_quote_xlsx', analysis_id=analysis_id) }}">Export Excel Quote</a>
        </div>
    {% endif %}

    <section class="next-actions">
        <h3>Actions</h3>
        <div class="cta-grid">
            {% if image_metadata %}
            <a class="cta-button" href="{{ url_for('download_converted_dxf_analysis', analysis_id=analysis_id) }}">Download converted DXF</a>
            {% endif %}
            {% if available_assets.preview %}
            <a class="cta-button" href="{{ url_for('download_file', analysis_id=analysis_id, file_type='preview') }}">Download preview</a>
            {% endif %}
            {% if image_metadata %}
            <form method="post" action="{{ url_for('route_converted_dxf') }}" class="inline-form">
                <input type="hidden" name="analysis_id" value="{{ analysis_id }}">
                <label for="route_target">Send DXF to:</label>
                <select name="route_target" id="route_target">
                    <option value="analysis">DXF Analysis</option>
                    <option value="nesting">Nesting</option>
                    <option value="gcode">G-code Generation</option>
                </select>
                <button type="submit">Go</button>
            </form>
            {% endif %}
            <a class="link-button" href="{{ url_for('index') }}">Back to Workflow</a>
        </div>
    </section>
</section>
{% endblock %}
